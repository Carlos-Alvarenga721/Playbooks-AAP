---
# =============================================================================
# PLAYBOOK MAESTRO: CIS COMPLIANCE WORKFLOW
# =============================================================================
# Orquesta el flujo completo: AuditorÃ­a â†’ RemediaciÃ³n â†’ Re-AuditorÃ­a â†’ Reporte
# DiseÃ±ado para ser ejecutado desde AAP Controller con Surveys
# =============================================================================
# USO DESDE TERMINAL:
#   # Solo auditorÃ­a + reporte:
#   ansible-playbook playbooks/cis_compliance_workflow.yml -i inventories/gcp_hosts.yml
#
#   # AuditorÃ­a + RemediaciÃ³n + Reporte:
#   ansible-playbook playbooks/cis_compliance_workflow.yml -i inventories/gcp_hosts.yml \
#     -e "apply_remediation=true" -e "email_enabled=true"
#
# VARIABLES PARA SURVEY EN AAP:
#   - target_servers: Servidores a auditar (default: linux_servers)
#   - apply_remediation: Aplicar correcciones (true/false)
#   - email_enabled: Enviar reporte por email (true/false)
#   - email_recipients: Lista de destinatarios
# =============================================================================

- name: "FASE 1: AuditorÃ­a Inicial CIS Benchmark"
  hosts: "{{ target_servers | default('linux_servers') }}"
  gather_facts: yes
  become: yes
  
  pre_tasks:
    - name: Registrar inicio del workflow
      ansible.builtin.set_fact:
        workflow_start_time: "{{ ansible_date_time.iso8601 }}"
        workflow_id: "WF-{{ ansible_date_time.epoch }}"

    - name: Mostrar banner de inicio
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘         ğŸ”’ CIS COMPLIANCE WORKFLOW - ANSIBLE AUTOMATION PLATFORM     â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  Workflow ID: {{ workflow_id }}
          â•‘  Fecha/Hora: {{ workflow_start_time }}
          â•‘  Servidores Target: {{ target_servers | default('linux_servers') }}
          â•‘  RemediaciÃ³n: {{ 'HABILITADA âš ï¸' if apply_remediation | default(false) else 'DESHABILITADA' }}
          â•‘  NotificaciÃ³n Email: {{ 'HABILITADA' if email_enabled | default(false) else 'DESHABILITADA' }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  roles:
    - role: cis_audit

  post_tasks:
    - name: Guardar resultados de auditorÃ­a inicial
      ansible.builtin.set_fact:
        initial_audit_results: "{{ cis_audit_results }}"
        initial_audit_summary: "{{ audit_summary }}"
        pre_remediation_compliance: "{{ audit_summary.compliance_percentage }}"

    - name: Mostrar resumen de auditorÃ­a inicial
      ansible.builtin.debug:
        msg: |
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ“Š FASE 1 COMPLETADA: AuditorÃ­a Inicial                    â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          â”‚  Servidor: {{ inventory_hostname }}
          â”‚  Cumplimiento: {{ audit_summary.compliance_percentage }}%
          â”‚  Controles OK: {{ audit_summary.passed }} / {{ audit_summary.total_controls }}
          â”‚  Controles FAIL: {{ audit_summary.failed }}
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

# =============================================================================
# FASE 2: REMEDIACIÃ“N (Solo si estÃ¡ habilitada)
# =============================================================================
- name: "FASE 2: RemediaciÃ³n AutomÃ¡tica CIS"
  hosts: "{{ target_servers | default('linux_servers') }}"
  gather_facts: yes
  become: yes
  
  pre_tasks:
    - name: Verificar si se requiere remediaciÃ³n
      ansible.builtin.debug:
        msg: |
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ”§ FASE 2: RemediaciÃ³n AutomÃ¡tica                          â”‚
          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
          {% if apply_remediation | default(false) %}
          â”‚  Estado: EJECUTANDO REMEDIACIONES...                        â”‚
          {% else %}
          â”‚  Estado: OMITIDA (apply_remediation=false)                  â”‚
          {% endif %}
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      when: true

  roles:
    - role: cis_remediation
      when: apply_remediation | default(false)

  post_tasks:
    - name: Guardar resultados de remediaciÃ³n
      ansible.builtin.set_fact:
        remediation_completed: "{{ apply_remediation | default(false) }}"
        remediation_count: "{{ remediation_results | default([]) | length }}"
      when: apply_remediation | default(false)

# =============================================================================
# FASE 3: RE-AUDITORÃA (Solo si hubo remediaciÃ³n)
# =============================================================================
- name: "FASE 3: Re-AuditorÃ­a Post-RemediaciÃ³n"
  hosts: "{{ target_servers | default('linux_servers') }}"
  gather_facts: yes
  become: yes
  
  pre_tasks:
    - name: Mostrar inicio de re-auditorÃ­a
      ansible.builtin.debug:
        msg: |
          
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚  ğŸ”„ FASE 3: Re-AuditorÃ­a Post-RemediaciÃ³n                   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      when: apply_remediation | default(false)

  roles:
    - role: cis_audit
      when: apply_remediation | default(false)

  post_tasks:
    - name: Guardar resultados de re-auditorÃ­a
      ansible.builtin.set_fact:
        post_remediation_compliance: "{{ audit_summary.compliance_percentage }}"
        final_audit_results: "{{ cis_audit_results }}"
        final_audit_summary: "{{ audit_summary }}"
      when: apply_remediation | default(false)

    - name: Establecer resultados finales (sin remediaciÃ³n)
      ansible.builtin.set_fact:
        post_remediation_compliance: "{{ pre_remediation_compliance }}"
        final_audit_results: "{{ initial_audit_results }}"
        final_audit_summary: "{{ initial_audit_summary }}"
      when: not apply_remediation | default(false)

# =============================================================================
# FASE 4: GENERACIÃ“N DE REPORTE Y NOTIFICACIÃ“N
# =============================================================================
- name: "FASE 4: GeneraciÃ³n de Reporte y NotificaciÃ³n"
  hosts: "{{ target_servers | default('linux_servers') }}"
  gather_facts: yes
  become: yes

  pre_tasks:
    - name: Preparar datos del reporte con comparativa
      ansible.builtin.set_fact:
        remediation_applied: "{{ apply_remediation | default(false) }}"
        pre_compliance: "{{ pre_remediation_compliance }}"
        post_compliance: "{{ post_remediation_compliance }}"
        remediated_count: "{{ remediation_count | default(0) }}"
        cis_audit_results: "{{ final_audit_results }}"
        audit_summary: "{{ final_audit_summary }}"

  roles:
    - role: cis_reporting

  post_tasks:
    - name: Mostrar resumen final del workflow
      ansible.builtin.debug:
        msg: |
          
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘              âœ… WORKFLOW COMPLETADO EXITOSAMENTE                     â•‘
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}
          â•‘  ğŸ†” Workflow ID: {{ workflow_id }}
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ“Š RESULTADOS:                                                      â•‘
          â•‘  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â•‘
          â•‘  Cumplimiento Inicial: {{ pre_remediation_compliance }}%
          {% if apply_remediation | default(false) %}
          â•‘  Controles Remediados: {{ remediated_count }}
          â•‘  Cumplimiento Final: {{ post_remediation_compliance }}%
          â•‘  Mejora: +{{ (post_remediation_compliance | float - pre_remediation_compliance | float) | round(1) }}%
          {% else %}
          â•‘  RemediaciÃ³n: No aplicada
          â•‘  Cumplimiento Actual: {{ post_remediation_compliance }}%
          {% endif %}
          â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
          â•‘  ğŸ“„ Reporte guardado en: {{ report_config.output_dir }}
          {% if email_enabled | default(false) %}
          â•‘  ğŸ“§ Email enviado a: {{ email_config.to_addresses | join(', ') }}
          {% endif %}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
