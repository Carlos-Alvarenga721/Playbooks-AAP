---
# =============================================================================
# PLAYBOOK: GENERATE CIS COMPLIANCE REPORT
# =============================================================================
# Ejecuta auditorÃ­a CIS y genera reporte HTML con envÃ­o por email
# =============================================================================
# USO:
#   # Generar reporte sin enviar email:
#   ansible-playbook playbooks/03_generate_report.yml -i inventories/gcp_hosts.yml
#
#   # Generar y enviar por email:
#   ansible-playbook playbooks/03_generate_report.yml -i inventories/gcp_hosts.yml -e "email_enabled=true"
#
#   # Para servidor especÃ­fico:
#   ansible-playbook playbooks/03_generate_report.yml -i inventories/gcp_hosts.yml --limit web-server
# =============================================================================

- name: CIS Compliance Report - AuditorÃ­a y GeneraciÃ³n de Reporte
  hosts: linux_servers
  gather_facts: yes
  become: yes

  pre_tasks:
    - name: Mostrar inicio de proceso
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ“Š GENERACIÃ“N DE REPORTE DE CUMPLIMIENTO CIS
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}
          ğŸŒ IP: {{ ansible_host }}
          ğŸ§ Sistema Operativo: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ“… Fecha: {{ ansible_date_time.iso8601 }}
          ğŸ“§ EnvÃ­o Email: {{ 'Habilitado' if email_enabled | default(false) else 'Deshabilitado' }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  roles:
    # Primero ejecuta la auditorÃ­a
    - role: cis_audit
    
    # Luego genera el reporte
    - role: cis_reporting

  post_tasks:
    - name: Resumen final del proceso
      ansible.builtin.debug:
        msg: |
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… PROCESO COMPLETADO
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}
          ğŸ“Š Cumplimiento: {{ audit_summary.compliance_percentage }}%
          âœ… Controles OK: {{ audit_summary.passed }}
          âŒ Controles FAIL: {{ audit_summary.failed }}
          ğŸ“„ Reporte guardado en: {{ report_config.output_dir }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•