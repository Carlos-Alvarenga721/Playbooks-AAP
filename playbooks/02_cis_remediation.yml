---
# =============================================================================
# PLAYBOOK: CIS REMEDIATION
# =============================================================================
# Aplica remediaciÃ³n automÃ¡tica de controles CIS Benchmark Level 1
# âš ï¸ IMPORTANTE: Por defecto la remediaciÃ³n estÃ¡ DESACTIVADA
# =============================================================================
# USO:
#   # Solo auditar (modo seguro):
#   ansible-playbook playbooks/02_cis_remediation.yml -i inventories/gcp_hosts.yml
#
#   # Aplicar remediaciones:
#   ansible-playbook playbooks/02_cis_remediation.yml -i inventories/gcp_hosts.yml -e "apply_remediation=true"
#
#   # Remediar servidor especÃ­fico:
#   ansible-playbook playbooks/02_cis_remediation.yml -i inventories/gcp_hosts.yml -e "apply_remediation=true" --limit web-server
# =============================================================================

- name: CIS Benchmark Level 1 - RemediaciÃ³n AutomÃ¡tica
  hosts: linux_servers
  gather_facts: yes
  become: yes

  pre_tasks:
    - name: Mostrar advertencia de remediaciÃ³n
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âš ï¸  REMEDIACIÃ“N CIS BENCHMARK - {{ 'MODO ACTIVO' if apply_remediation | default(false) else 'MODO SIMULACIÃ“N' }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}
          ğŸŒ IP: {{ ansible_host }}
          ğŸ§ Sistema Operativo: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ“… Fecha: {{ ansible_date_time.iso8601 }}
          ğŸ”’ Nivel CIS: {{ cis_level | default(1) }}
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          {% if not apply_remediation | default(false) %}
          â„¹ï¸  Para aplicar cambios ejecute con: -e "apply_remediation=true"
          {% else %}
          âš ï¸  SE APLICARÃN CAMBIOS EN EL SISTEMA
          {% endif %}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Capturar estado ANTES de remediaciÃ³n
      ansible.builtin.set_fact:
        pre_remediation_state:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          hostname: "{{ inventory_hostname }}"
          kernel: "{{ ansible_kernel }}"
          uptime_seconds: "{{ ansible_uptime_seconds }}"

  roles:
    - role: cis_remediation

  post_tasks:
    - name: Capturar estado DESPUÃ‰S de remediaciÃ³n
      ansible.builtin.set_fact:
        post_remediation_state:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          remediation_applied: "{{ apply_remediation | default(false) }}"
          controls_remediated: "{{ remediation_results | length }}"

    - name: Guardar resultados para reporte
      ansible.builtin.set_fact:
        server_remediation_results:
          hostname: "{{ inventory_hostname }}"
          ip: "{{ ansible_host }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          pre_state: "{{ pre_remediation_state }}"
          post_state: "{{ post_remediation_state }}"
          results: "{{ remediation_results }}"
          summary: "{{ remediation_summary }}"
      delegate_to: localhost
      run_once: false