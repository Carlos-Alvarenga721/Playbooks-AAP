---
# =============================================================================
# PLAYBOOK: CIS AUDIT SCAN
# =============================================================================
# Ejecuta auditorÃ­a de CIS Benchmark Level 1 en servidores Linux
# Genera resultados detallados por cada control verificado
# =============================================================================
# USO:
#   ansible-playbook playbooks/01_cis_audit_scan.yml -i inventories/gcp_hosts.yml
#
# VARIABLES OPCIONALES:
#   -e "cis_level=1"           â†’ Nivel de CIS Benchmark (1 o 2)
#   -e "apply_remediation=false" â†’ No aplica correcciones (solo audita)
# =============================================================================

- name: CIS Benchmark Level 1 - AuditorÃ­a de Seguridad
  hosts: linux_servers
  gather_facts: yes
  become: yes

  pre_tasks:
    - name: Mostrar informaciÃ³n del servidor objetivo
      ansible.builtin.debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          INICIANDO AUDITORÃA CIS BENCHMARK
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ğŸ–¥ï¸  Servidor: {{ inventory_hostname }}
          ğŸŒ IP: {{ ansible_host }}
          ğŸ§ Sistema Operativo: {{ ansible_distribution }} {{ ansible_distribution_version }}
          ğŸ“… Fecha de Escaneo: {{ ansible_date_time.iso8601 }}
          ğŸ”’ Nivel CIS: {{ cis_level | default(1) }}
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  roles:
    - role: cis_audit

  post_tasks:
    - name: Guardar resultados en variable global
      ansible.builtin.set_fact:
        server_audit_results:
          hostname: "{{ inventory_hostname }}"
          ip: "{{ ansible_host }}"
          os: "{{ ansible_distribution }} {{ ansible_distribution_version }}"
          results: "{{ cis_audit_results }}"
          summary: "{{ audit_summary }}"
      delegate_to: localhost
      run_once: false